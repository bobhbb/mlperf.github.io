<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="shortcut icon" href="mlperf_icon.png">
<title>LoadGen: Building the LoadGen</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top" style="display:flex; flex-flow:row wrap; justify-content:flex-start; align-items:center;"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea" style="display:flex; flex-flow:row wrap; justify-content:flex-start; align-items:center;">
  <a href="https://www.mlperf.org"><img alt="MLPerf" src="mlperf_logo_horizontal_color.svg"/ height="55px"></a>
  <div style="padding-left: 1em;">
    <div id="projectname"><a href="index.html">LoadGen Guide</a>
   </div>
  </div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('ReadmeBuild.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Building the LoadGen </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Prerequisites</h2>
<pre class="fragment">sudo apt-get install libglib2.0-dev python-pip python3-pip
pip2 install absl-py numpy
pip3 install absl-py numpy
</pre><h2>Quick Start</h2>
<pre class="fragment">pip install absl-py numpy
git clone --recurse-submodules https://github.com/mlperf/inference.git mlperf_inference
cd mlperf_inference/loadgen
CFLAGS="-std=c++14 -O3" python setup.py bdist_wheel
pip install --force-reinstall dist/mlperf_loadgen-0.5a0-cp36-cp36m-linux_x86_64.whl
python demos/py_demo_single_stream.py
</pre><p>This will fetch the loadgen source, build and install the loadgen as a python module, and run a simple end-to-end demo. The exact *.whl filename may differ on your system, but there should only be one resulting whl file for you to use.</p>
<p>A summary of the test results can be found in the *"mlperf_log_summary.txt"* logfile.</p>
<p>For a timeline visualization of what happened during the test, open the *"mlperf_log_trace.json"* file in Chrome:</p><ul>
<li>Type “chrome://tracing” in the address bar, then drag-n-drop the json.</li>
<li>This may be useful for SUT performance tuning and understanding + debugging the loadgen.</li>
</ul>
<p>To build the loadgen as a C++ library, rather than a python module: </p><pre class="fragment">git clone --recurse-submodules https://github.com/mlperf/inference.git mlperf_inference
cd mlperf_inference
make mlperf_loadgen
cp out/MakefileGnProj/obj/loadgen/libmlperf_loadgen.a .
</pre><p>Alternatively: </p><pre class="fragment">git clone https://github.com/mlperf/inference.git mlperf_inference
cd mlperf_inference
mkdir loadgen/build/ &amp;&amp; cd loadgen/build/
cmake .. &amp;&amp; cmake --build .
cp libmlperf_loadgen.a ..
</pre><h2>Overview</h2>
<p>The load generator is built using the <a href="https://gn.googlesource.com/gn/+/master">gn metabuild</a> and <a href="https://ninja-build.org/">ninja build</a> tools.</p>
<p>Using git submodules to manage a checkout will compile gn and ninja if needed. Using depot_tools to manage a checkout will include prebuilt versions of gn and ninja. By default, both ways will use the system C++ compiler, however depot_tools also has the option to use versioned compiler binaries.</p>
<p>If the tools above don't cover your particular configuration, please reach out. Patches to support other build environments welcome.</p>
<h2>Git Submodules Approach</h2>
<h3>Downloading the source</h3>
<p>Download the mlperf inference repository and its submodules. </p><pre class="fragment">git clone --recurse-submodules https://github.com/mlperf/inference.git
</pre><h3>Build from source</h3>
<h4>Just building once</h4>
<p>The following is a phony Makefile target, wrapping everything needed to build the load generator. It'll get the job done, but will result in lots of redundant work if used over and over again, so isn't recommended for development. The resulting binary will be found in: out/MakefileGnProj/obj/loadgen/libmlperf_loadgen.* </p><pre class="fragment">make mlperf_loadgen
</pre><p>To build the python module: </p><pre class="fragment">make mlperf_loadgen_pymodule
</pre><p>Note: These make targets assume Unix-like shell commands are available.</p>
<h4>Building for development purposes</h4>
<p>The bootstrap_gn_ninja make target will build ninja and gn into the current tree and should only need to be called once per checkout. This is not necessary if you already have gn and ninja installed on your system. </p><pre class="fragment">make bootstrap_gn_ninja
</pre><p>Then generate the ninja build files from the gn build files. You can have multiple sets of ninja build files in different out directories, each with their own args. Release and debug sets, for example: </p><pre class="fragment">third_party/gn/gn gen out/Release --args="is_debug=false"
third_party/gn/gn gen out/Debug --args="is_debug=true"
</pre><p>From here you can edit+build over and over using one of the following targets: </p><pre class="fragment">third_party/ninja/ninja -C out/Release mlperf_loadgen
third_party/ninja/ninja -C out/Release loadgen_pymodule_wheel_src
</pre><p>You will find the binary in *"out/Release/obj/loadgen/libmlperf\_loadgen.a"*. (Or as a .lib on Windows).</p>
<p>Link that library directly into the executable you want to test.</p>
<p>Optionally, create a project file for your favorite IDE. See <a href="https://gn.googlesource.com/gn/+/master/docs/reference.md#ide-options">gn documentation</a> for details. </p><pre class="fragment">gn gen --root=src --ide=eclipse out/Release
gn gen --root=src --ide=vs out/Release
gn gen --root=src --ide=xcode out/Release
gn gen --root=src --ide=qtcreator out/Release
</pre><h2>Depot Tools approach</h2>
<h3>Downloading the source</h3>
<p>Download and install depot_tools: </p><pre class="fragment">git clone 'https://chromium.googlesource.com/chromium/tools/depot_tools.git'
export PATH="${PWD}/depot_tools:${PATH}"
</pre><p>Copy the depot_tools fetch config for the MLPerf load generator to the depot_tools path: </p><pre class="fragment">wget https://raw.githubusercontent.com/mlperf/inference/master/loadgen/depot_tools/fetch_configs/mlperf_loadgen.py \
-O ${PWD}/depot_tools/fetch_configs/mlperf_loadgen.py
</pre><p>Create a folder for the load generator project and fetch the source code: </p><pre class="fragment">mkdir mlperf_loadgen
cd mlperf_loadgen
fetch mlperf_loadgen
gclient sync
</pre><h3>Building from source</h3>
<p>The depot_tools approach enables building with versioned toolchains.</p>
<p><em>Note: This has only been tested to work in a Debian-based linux environment so far, but it should support many others.</em></p>
<p>Run the gn metabuild. The output directory will contain ninja build files for a specific target platform and set of build options. </p><pre class="fragment">gn gen --root=src out/Default
</pre><p>TODO: Provide gn commands for cross-compiling to Android and to iOS. In the mean time, looking at how to build chromium https://chromium.googlesource.com/chromium/src/+/master/docs/android_build_instructions.md "for android" or https://chromium.googlesource.com/chromium/src/+/HEAD/docs/ios/build_instructions.md "for ios" should provide some useful pointers.</p>
<p>Build the library: </p><pre class="fragment">ninja -C out/Default mlperf_loadgen
</pre><p>You will find the binary in *"out/Release/obj/loadgen/libmlperf\_loadgen.a"*. (Or as a .lib on Windows).</p>
<p>Link that library directly into the executable you want to test.</p>
<h2>Notes about important dependency and build files</h2>
<p><b>DEPS</b>: Describes source repositories to pull in as dependencies depot_tools' "gclient sync" command. Also runs system commands to download the relevant toolchains for the "gclient runhooks" command, which is run as part of the initial "fetch".</p>
<p>**.gitmodules**: Git submodules alternative to DEPS.</p>
<p>**.gn**: The root gn build file.</p>
<p><b>BUILD.gn</b>: Located in multiple directories. Each one describes how to build that particular directory. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      <div style="flex-grow:1"></div>
      <div>
        Generated by
        <a href="http://www.doxygen.org/index.html">doxygen</a>
        1.8.13
      </div>
    </li>
  </ul>
</div>
</body>
</html>
